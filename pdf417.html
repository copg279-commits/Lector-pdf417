<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lector PDF417 Nativo - Sin Conversión</title>
</head>
<body style="font-family: sans-serif; padding: 20px; background-color: #f7f7f7;">

    <h3>Lector de Código PDF417 (Licencia Colombia) - Puro</h3>
    
    <p>1. Selecciona la imagen real de la licencia:</p>
    <input type="file" id="fileInput" accept="image/*" style="margin-bottom: 20px;">
    
    <div id="status" style="margin-top: 10px; color: #555;">Esperando imagen...</div>

    <p><strong>2. Resultado Crudo (Texto Extraído):</strong></p>
    <pre id="result" style="background-color: #eee; padding: 15px; border: 1px solid #ccc; border-radius: 4px; min-height: 80px; white-space: pre-wrap; word-break: break-all; font-family: monospace;"></pre>

    <p><strong>3. Visualización del Código Leído (Ampliado):</strong></p>
    <div id="visualResult" style="border: 2px solid #ccc; padding: 5px; display: none; background: #fff; max-width: 100%; text-align: center;">
        <p style="margin: 0 0 10px 0; font-size: 12px; color: #777;">Esta es una vista ampliada de la zona del código para tu referencia visual. El lector usó la imagen original.</p>
        <canvas id="visualCanvas" style="border: 1px solid #eee;"></canvas>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const resultText = document.getElementById('result');
        const status = document.getElementById('status');
        const visualResult = document.getElementById('visualResult');
        const visualCanvas = document.getElementById('visualCanvas');
        const visualCtx = visualCanvas.getContext('2d');

        // Paso 1: Escuchar el evento de cambio de archivo
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "Estado: Cargando imagen original...";
            resultText.innerText = "";
            visualResult.style.display = 'none';

            // Paso 2: Crear un objeto Image y cargar el archivo puro
            const img = new Image();
            img.onload = async () => {
                // Una vez cargada la imagen real, intentamos detectarla
                status.innerText = "Estado: Analizando imagen pura con BarcodeDetector API...";
                
                try {
                    // Paso 3: Usar la API NATIVA del navegador. 
                    // No hay pre-procesamiento, no hay conversión. El navegador lee la imagen real.
                    const detector = new BarcodeDetector({ formats: ['pdf417'] });
                    const barcodes = await detector.detect(img);

                    if (barcodes.length > 0) {
                        status.innerText = "✅ ¡Lectura exitosa!";
                        // Mostrar el resultado crudo
                        resultText.innerText = barcodes[0].rawValue;

                        // Paso 4: Encuadrar y Recortar (PARA VISUALIZACIÓN SOLAMENTE)
                        // Esto no afecta a la lectura, solo muestra al usuario qué se leyó.
                        const codeArea = barcodes[0].boundingBox;
                        visualCanvas.width = codeArea.width * 2; // Ampliar visualmente
                        visualCanvas.height = codeArea.height * 2; // Ampliar visualmente
                        
                        // Recortar de la imagen original (img) y dibujar ampliada
                        visualCtx.drawImage(img, 
                            codeArea.x, codeArea.y, codeArea.width, codeArea.height, // Recorte original
                            0, 0, visualCanvas.width, visualCanvas.height); // Dibujo ampliado
                        
                        visualResult.style.display = 'block';

                    } else {
                        status.innerText = "❌ No se detectó código PDF417 en esta imagen. Asegúrate de que esté bien enfocada.";
                        resultText.innerText = "";
                    }
                } catch (err) {
                    // Si el navegador no soporta BarcodeDetector (muy raro en Chrome/Edge modernos)
                    status.innerText = "Error: Tu navegador no soporta la BarcodeDetector API nativa. Prueba con Chrome o Edge actualizados.";
                    resultText.innerText = "Error completo: " + err.message;
                    console.error("Error completo:", err);
                }
            };
            
            // Usar URL.createObjectURL para que la imagen se cargue lo más rápido posible sin conversiones
            img.src = URL.createObjectURL(file);
        });
    </script>
</body>
</html>